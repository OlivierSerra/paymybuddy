package com.example.paymybuddy.config;

import com.example.paymybuddy.repository.UserRepository;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.*;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;

@Configuration
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http
            // Laisse CSRF ACTIVÉ (valeur par défaut). Tes formulaires doivent inclure le token.
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/", "/login", "/style.css", "/webjars/**", "/images/**").permitAll()
                // le reste nécessite une authentification :
                .requestMatchers("/transactions/**", "/buddies/**", "/ListeUsers", "/ListeTransactions").authenticated()
                .anyRequest().authenticated()
            )
            .formLogin(form -> form
                // page de login par défaut de Spring Security (pas besoin de template)
                .defaultSuccessUrl("/ListeUsers", true)
                .permitAll()
            )
            .logout(logout -> logout
                .logoutSuccessUrl("/login?logout")
            );
        return http.build();
    }

    @Bean
    public UserDetailsService userDetailsService(UserRepository repo) {
        return username -> repo.findByUsername(username)
            .map(u -> {
                // On accepte "ADMIN" / "USER" (on préfixe) ou déjà "ROLE_ADMIN" / "ROLE_USER"
                String role = u.getRole();
                String authority = role != null && role.startsWith("ROLE_") ? role : "ROLE_" + role;
                return User.withUsername(u.getUsername())
                        .password(u.getPassword()) // doit être encodé BCrypt en base
                        .authorities(new SimpleGrantedAuthority(authority))
                        .build();
            })
            .orElseThrow(() -> new UsernameNotFoundException("Utilisateur introuvable: " + username));
    }

    @Bean
    public BCryptPasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
